<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garden Viz - Interactive Landscape Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Garden Viz</h1>
    <p class="subtitle">Interactive Landscape Plan Viewer</p>
  </header>

  <main>
    <!-- Step 1: Upload -->
    <div class="upload-area" id="uploadArea">
      <div class="upload-prompt" id="uploadPrompt">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <p>Drop a landscape plan image here, or click to upload</p>
        <p class="hint">Supports PNG, JPG</p>
        <input type="file" id="fileInput" accept="image/*" hidden>
      </div>
    </div>

    <!-- Step 2: Viewer -->
    <div class="viewer-container" id="viewerContainer" style="display:none;">
      <div class="toolbar">
        <button id="btnZoomIn" title="Zoom In">+</button>
        <button id="btnZoomOut" title="Zoom Out">&minus;</button>
        <button id="btnFitView" title="Fit to View">Fit</button>
        <span class="separator"></span>
        <button id="btnParseLegend" title="Auto-parse a legend image or region">Parse Legend</button>
        <button id="btnPickColor" title="Pick a color from the legend manually">Pick Color</button>
        <button id="btnScanAll" title="Scan image for all mapped colors">Scan All</button>
        <span class="separator"></span>
        <button id="btnExport" title="Export project as JSON">Export</button>
        <button id="btnImport" title="Import project from JSON">Import</button>
        <input type="file" id="importInput" accept=".json" hidden>
        <span class="separator"></span>
        <button id="btnNewImage" title="Load new image">New Image</button>
      </div>

      <div class="workspace">
        <!-- Left panel: Color Legend -->
        <aside class="legend-panel" id="legendPanel">
          <h3>Color Legend</h3>
          <p class="legend-hint">Use <strong>Parse Legend</strong> to auto-detect plants from a legend image, or <strong>Pick Color</strong> to map colors manually.</p>
          <div id="colorEntries"></div>
          <div class="tolerance-control">
            <label>Color Tolerance: <span id="tolValue">40</span></label>
            <input type="range" id="tolSlider" min="15" max="80" value="40">
          </div>
        </aside>

        <!-- Canvas area -->
        <div class="canvas-wrap" id="canvasWrap">
          <canvas id="planCanvas"></canvas>
          <canvas id="highlightCanvas"></canvas>
          <div class="crop-selection" id="cropSelection" style="display:none;"></div>
          <div class="markers-overlay" id="markersOverlay"></div>
          <!-- Progress overlay -->
          <div class="scan-progress" id="scanProgress" style="display:none;">
            <div class="scan-progress-inner">
              <div class="scan-progress-bar" id="scanProgressBar"></div>
              <span id="scanProgressText">Scanning... 0%</span>
            </div>
          </div>
        </div>

        <!-- Right panel: Plant Detail -->
        <aside class="detail-panel" id="detailPanel">
          <div class="panel-placeholder" id="panelPlaceholder">
            <p>Click on a plant marker to see its details.</p>
            <p class="hint">Start by parsing the legend or picking colors manually.</p>
          </div>
          <div class="panel-content" id="panelContent" style="display:none;">
            <div class="panel-header">
              <h2 id="plantName">Plant Name</h2>
              <button class="btn-delete" id="btnDeleteMarker" title="Delete this marker">&times;</button>
            </div>
            <div class="plant-photos" id="plantPhotos"></div>
            <div class="field">
              <label>Common Name</label>
              <input type="text" id="fieldCommon" placeholder="e.g. Blue Fescue">
            </div>
            <div class="field">
              <label>Botanical Name</label>
              <input type="text" id="fieldBotanical" placeholder="e.g. Festuca glauca">
            </div>
            <div class="field">
              <label>Type</label>
              <select id="fieldType">
                <option value="">-- select --</option>
                <option value="deciduous-tree">Deciduous Tree</option>
                <option value="evergreen-tree">Evergreen Tree</option>
                <option value="deciduous-shrub">Deciduous Shrub</option>
                <option value="evergreen-shrub">Evergreen Shrub</option>
                <option value="perennial">Perennial</option>
                <option value="perennial-bulb">Perennial Bulb</option>
                <option value="annual">Annual</option>
                <option value="ornamental-grass">Ornamental Grass</option>
                <option value="ground-cover">Ground Cover</option>
                <option value="vine">Vine</option>
                <option value="succulent">Succulent</option>
                <option value="fern">Fern</option>
              </select>
            </div>
            <div class="field">
              <label>Mature Size</label>
              <input type="text" id="fieldSize" placeholder="e.g. 2-3 ft tall, 2 ft wide">
            </div>
            <div class="field">
              <label>Bloom Season</label>
              <input type="text" id="fieldBloom" placeholder="e.g. Late Spring - Summer">
            </div>
            <div class="field">
              <label>Sun Requirements</label>
              <select id="fieldSun">
                <option value="">-- select --</option>
                <option value="full-sun">Full Sun</option>
                <option value="part-sun">Part Sun</option>
                <option value="part-shade">Part Shade</option>
                <option value="full-shade">Full Shade</option>
              </select>
            </div>
            <div class="field">
              <label>Water Needs</label>
              <select id="fieldWater">
                <option value="">-- select --</option>
                <option value="low">Low</option>
                <option value="moderate">Moderate</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="field">
              <label>Notes</label>
              <textarea id="fieldNotes" rows="3" placeholder="Any additional notes..."></textarea>
            </div>
            <div class="marker-color-swatch" id="markerColorSwatch"></div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Color naming modal -->
    <div class="modal-backdrop" id="colorModal" style="display:none;">
      <div class="modal">
        <h3>Name This Plant</h3>
        <div class="modal-color-preview">
          <div class="color-swatch-lg" id="modalSwatch"></div>
          <div id="modalTemplatePreview" style="display:none;"></div>
          <span id="modalColorText"></span>
        </div>
        <div class="field">
          <label>Plant Name</label>
          <input type="text" id="modalPlantName" placeholder="e.g. Hydrangea" list="plantSuggestions" autocomplete="off">
          <datalist id="plantSuggestions"></datalist>
        </div>
        <div class="modal-buttons">
          <button class="btn-cancel" id="modalCancel">Cancel</button>
          <button class="btn-save" id="modalConfirm">Add to Legend</button>
        </div>
      </div>
    </div>

    <!-- Legend parse modal -->
    <div class="modal-backdrop" id="legendModal" style="display:none;">
      <div class="modal legend-modal">
        <h3>Parse Legend</h3>

        <div class="legend-tabs">
          <button class="legend-tab active" data-tab="upload">Upload Legend Image</button>
          <button class="legend-tab" data-tab="crop">Select from Plan</button>
        </div>

        <!-- Tab: Upload separate legend -->
        <div class="legend-tab-content" id="legendTabUpload">
          <div class="legend-upload-zone" id="legendUploadZone">
            <p>Drop a legend image here, or click to select</p>
            <p class="hint">A cropped image of just the legend/key area</p>
            <input type="file" id="legendFileInput" accept="image/*" hidden>
          </div>
          <div class="legend-preview" id="legendUploadPreview" style="display:none;">
            <img id="legendPreviewImg" alt="Legend preview">
            <button class="btn-small" id="btnClearLegendUpload">Clear</button>
          </div>
        </div>

        <!-- Tab: Crop from plan -->
        <div class="legend-tab-content" id="legendTabCrop" style="display:none;">
          <p class="hint">Close this dialog, then draw a rectangle over the legend area on your plan. Click <strong>Parse Legend</strong> again when done.</p>
          <button class="btn-save" id="btnStartCrop">Start Selecting</button>
          <div class="legend-preview" id="legendCropPreview" style="display:none;">
            <canvas id="legendCropCanvas"></canvas>
            <p class="hint" id="cropSizeText"></p>
          </div>
        </div>

        <!-- Parse progress -->
        <div class="legend-progress" id="legendProgress" style="display:none;">
          <div class="legend-progress-bar-track">
            <div class="legend-progress-bar" id="legendProgressBar"></div>
          </div>
          <span class="legend-progress-text" id="legendProgressText">Initializing OCR...</span>
        </div>

        <!-- Parsed results -->
        <div class="legend-results" id="legendResults" style="display:none;">
          <h4>Detected Plants <span class="legend-results-count" id="legendResultsCount"></span></h4>
          <div class="legend-results-list" id="legendResultsList"></div>
        </div>

        <div class="modal-buttons">
          <button class="btn-cancel" id="legendModalCancel">Cancel</button>
          <button class="btn-save" id="legendModalParse" disabled>Parse</button>
          <button class="btn-save" id="legendModalConfirm" style="display:none;">Add All to Legend</button>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="plant-database.js"></script>
  <script src="color-scanner.js"></script>
  <script src="legend-parser.js"></script>
  <script src="app.js"></script>
</body>
</html>
